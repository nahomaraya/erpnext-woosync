{% extends "templates/web.html" %}

{% block page_content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>WooCommerce Sales Order Sync</h1>
            
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">WooCommerce Configuration</h5>
                    <form id="config-form">
                        <div class="form-group">
                            <label for="woocommerce_url">WooCommerce URL</label>
                            <input type="url" class="form-control" id="woocommerce_url" name="woocommerce_url" required>
                        </div>
                        <div class="form-group">
                            <label for="consumer_key">Consumer Key</label>
                            <input type="text" class="form-control" id="consumer_key" name="consumer_key" required>
                        </div>
                        <div class="form-group">
                            <label for="consumer_secret">Consumer Secret</label>
                            <input type="password" class="form-control" id="consumer_secret" name="consumer_secret" required>
                        </div>
                        <div class="form-group">
                            <label for="sync_interval">Sync Interval</label>
                            <select class="form-control" id="sync_interval" name="sync_interval">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="enable_sync" name="enable_sync">
                                <label class="custom-control-label" for="enable_sync">Enable Sync</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                    </form>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Sync Status</h5>
                    <div id="sync-status">
                        <p>Last Sync: <span id="last-sync">-</span></p>
                        <p>Status: <span id="status">-</span></p>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Manual Sync</h5>
                    <button class="btn btn-primary" id="sync-button">Sync Sales Orders</button>
                    <div id="sync-message" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    frappe.ready(function() {
        // Load initial sync status
        updateSyncStatus();

        // Add click handler for sync button
        $('#sync-button').click(function() {
            syncOrders();
        });

        // Handle configuration form submission
        $('#config-form').submit(function(e) {
            e.preventDefault();
            saveConfiguration();
        });
    });

    function updateSyncStatus() {
        frappe.call({
            method: 'woocommerce_sync.www.sync_sales_orders.get_sync_status',
            callback: function(response) {
                if (response.message) {
                    $('#last-sync').text(response.message.last_sync || '-');
                    $('#status').text(response.message.sync_status || '-');
                }
            }
        });
    }

    function syncOrders() {
        $('#sync-button').prop('disabled', true);
        $('#sync-message').html('<div class="alert alert-info">Syncing sales orders...</div>');

        frappe.call({
            method: 'woocommerce_sync.www.sync_sales_orders.sync_orders',
            callback: function(response) {
                if (response.message.status === 'success') {
                    $('#sync-message').html('<div class="alert alert-success">' + response.message.message + '</div>');
                } else {
                    $('#sync-message').html('<div class="alert alert-danger">' + response.message.message + '</div>');
                }
                $('#sync-button').prop('disabled', false);
                updateSyncStatus();
            }
        });
    }

    function saveConfiguration() {
        const configData = {
            woocommerce: {
                url: $('#woocommerce_url').val(),
                consumer_key: $('#consumer_key').val(),
                consumer_secret: $('#consumer_secret').val()
            },
            sync: {
                enable_sync: $('#enable_sync').is(':checked'),
                sync_interval: $('#sync_interval').val()
            }
        };

        frappe.call({
            method: 'woocommerce_sync.www.sync_sales_orders.update_config',
            args: {
                config_data: configData
            },
            callback: function(response) {
                if (response.message.status === 'success') {
                    frappe.show_alert({
                        message: 'Configuration saved successfully',
                        indicator: 'green'
                    });
                } else {
                    frappe.show_alert({
                        message: 'Error saving configuration: ' + response.message.message,
                        indicator: 'red'
                    });
                }
            }
        });
    }
</script>

<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .card-title {
        color: #36414c;
        font-weight: 500;
    }
    #sync-status {
        font-size: 1.1em;
    }
    #sync-message {
        min-height: 50px;
    }
    .form-group {
        margin-bottom: 1rem;
    }
</style>
{% endblock %} 